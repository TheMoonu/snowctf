# ÂÜÖÈÉ®ÁΩëÁªúÁâàÊú¨ - ‰∏çÊö¥Èú≤Êï∞ÊçÆÂ∫ìÁ´ØÂè£Âà∞‰∏ªÊú∫ÔºàÊõ¥ÂÆâÂÖ®Ôºâ
#
# üöÄ ÂêØÂä®ËØ¥ÊòéÔºö
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# 1. ÂêØÂä®Ê†∏ÂøÉÊúçÂä°ÔºàPostgreSQL + Redis + Django + NginxÔºâ:
#    docker-compose up -d
#
# 2. ÂêØÂä®ÂÖ®ÈÉ®ÊúçÂä°ÔºàÂåÖÂê´ Celery ÂºÇÊ≠•‰ªªÂä° + Flower ÁõëÊéßÔºâ:
#    docker-compose --profile Flower up -d
#
# 3. Êü•ÁúãÊâÄÊúâÊúçÂä°Áä∂ÊÄÅ:
#    docker-compose ps -a
#
# 4. ÂÅúÊ≠¢Âπ∂Âà†Èô§ÊâÄÊúâÊúçÂä°:
#    docker-compose --profile celery down
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

services:
  # PostgreSQL Êï∞ÊçÆÂ∫ì
  postgres:
    image: ${POSTGRES_IMAGE:-postgres:17-bookworm}
    container_name: ${CONTAINER_PREFIX:-secsnow}-postgres
    restart: always
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-secsnow}
      POSTGRES_USER: ${POSTGRES_USER:-secsnow}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-secsnow123456}
      PGDATA: /var/lib/postgresql/data/pgdata
      TZ: Asia/Shanghai
    volumes:
      - ${POSTGRES_DATA_DIR:-./db/postgres}:/var/lib/postgresql/data
    # ‰∏çÊö¥Èú≤Á´ØÂè£Âà∞‰∏ªÊú∫ÔºåÂè™Âú®ÂÜÖÈÉ®ÁΩëÁªúËÆøÈóÆ
    networks:
      - secsnow-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-secsnow}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PgBouncer ËøûÊé•Ê±†
  pgbouncer:
    image: ${PGBOUNCER_IMAGE:-edoburu/pgbouncer:latest}
    container_name: ${CONTAINER_PREFIX:-secsnow}-pgbouncer
    restart: always
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-secsnow}:${POSTGRES_PASSWORD:-secsnow123456}@postgres:5432/${POSTGRES_DB:-secsnow}
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 1000
      DEFAULT_POOL_SIZE: 25
      MIN_POOL_SIZE: 5
      RESERVE_POOL_SIZE: 5
      SERVER_IDLE_TIMEOUT: 60
      SERVER_LIFETIME: 3600
      MAX_DB_CONNECTIONS: 50
      TZ: Asia/Shanghai
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - secsnow-network
    healthcheck:
      test: ["CMD-SHELL", "PGPASSWORD=${POSTGRES_PASSWORD:-secsnow123456} psql -h 127.0.0.1 -p 5432 -U ${POSTGRES_USER:-secsnow} -d ${POSTGRES_DB:-secsnow} -c 'SELECT 1;' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Redis ÁºìÂ≠òÂíåÊ∂àÊÅØÈòüÂàó
  redis:
    image: ${REDIS_IMAGE:-redis:8.4.0}
    container_name: ${CONTAINER_PREFIX:-secsnow}-redis
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis123456} --appendonly yes
    environment:
      TZ: Asia/Shanghai
    volumes:
      - ${REDIS_DATA_DIR:-./redis/data}:/data
    # ‰∏çÊö¥Èú≤Á´ØÂè£Âà∞‰∏ªÊú∫ÔºåÂè™Âú®ÂÜÖÈÉ®ÁΩëÁªúËÆøÈóÆ
    networks:
      - secsnow-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Django Web Â∫îÁî®ÔºàÂâçÁ´ØÔºâ
  web:
    image: ${SECSNOW_IMAGE:-secsnow:secure}
    container_name: ${CONTAINER_PREFIX:-secsnow}-web
    restart: always
    env_file:                    # ‚¨Ö Êñ∞Â¢û
      - .env
    environment:
      # Django ÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºâ
      SNOW_SECRET_KEY: ${SNOW_SECRET_KEY:-django-insecure-)+vh#@l4crslu5fza1e8da!2(0s10mw5%_1=*uko7cu9ju*yv-}
      SNOW_DEBUG: ${SNOW_DEBUG:-False}
      SNOW_ALLOWED_HOSTS: ${SNOW_ALLOWED_HOSTS:-*}
      # Êï∞ÊçÆÂ∫ìÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºâ- ÈÄöËøá PgBouncer ËøûÊé•
      SNOW_POSTGRES_HOST: pgbouncer
      SNOW_POSTGRES_PORT: 5432
      SNOW_POSTGRES_NAME: ${POSTGRES_DB:-secsnow}
      SNOW_POSTGRES_USER: ${POSTGRES_USER:-secsnow}
      SNOW_POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-secsnow123456}
      # Redis ÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºâ
      SNOW_REDIS_HOST: redis
      SNOW_REDIS_PORT: 6379
      SNOW_REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123456}
      # Êó∂Âå∫ÈÖçÁΩÆ
      TZ: Asia/Shanghai
        
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${WEB_MEDIA_DIR:-./web/media}:/opt/cloud/secsnow/media
      - ${WEB_LOG_DIR:-./web/log}:/opt/cloud/secsnow/log
      - ${WEB_STATIC_DIR:-./web/static}:/opt/cloud/secsnow/static
      - ${WEB_WHOOSH_DIR:-./web/whoosh_index}:/opt/cloud/secsnow/whoosh_index
      # ÊåÇËΩΩÂÆø‰∏ªÊú∫‰ø°ÊÅØÔºàÁî®‰∫éÁîüÊàêÁ®≥ÂÆöÁöÑÊú∫Âô®Á†ÅÔºâ
      - /etc/machine-id:/host/etc/machine-id:ro
      - /sys/class/net:/host/sys/class/net:ro
    # ‰∏çÊö¥Èú≤Á´ØÂè£Âà∞‰∏ªÊú∫ÔºåÂè™ÈÄöËøá nginx ‰ª£ÁêÜËÆøÈóÆ
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - secsnow-network
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Celery WorkerÔºàÂÖ±‰∫´ web ÈïúÂÉèÔºâ
  celery-worker:
    image: ${SECSNOW_IMAGE:-secsnow:secure}
    container_name: ${CONTAINER_PREFIX:-secsnow}-celery-worker
    restart: always
    env_file:                    # ‚¨Ö Êñ∞Â¢û
      - .env
    command: celery -A secsnow worker -l info --concurrency=${CELERY_WORKER_CONCURRENCY:-4}
    environment:
      # Django ÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºâ
      SNOW_SECRET_KEY: ${SNOW_SECRET_KEY:-change-this-to-random-string}
      SNOW_DEBUG: ${SNOW_DEBUG:-False}
      # Êï∞ÊçÆÂ∫ìÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºâ- ÈÄöËøá PgBouncer ËøûÊé•
      SNOW_POSTGRES_HOST: pgbouncer
      SNOW_POSTGRES_PORT: 5432
      SNOW_POSTGRES_NAME: ${POSTGRES_DB:-secsnow}
      SNOW_POSTGRES_USER: ${POSTGRES_USER:-secsnow}
      SNOW_POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-secsnow123456}
      # Redis ÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºâ
      SNOW_REDIS_HOST: redis
      SNOW_REDIS_PORT: 6379
      SNOW_REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123456}
      # Êó∂Âå∫ÈÖçÁΩÆ
      TZ: Asia/Shanghai
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${WEB_MEDIA_DIR:-./web/media}:/opt/cloud/secsnow/media
      - ${WEB_LOG_DIR:-./web/log}:/opt/cloud/secsnow/log
      # ÊåÇËΩΩÂÆø‰∏ªÊú∫‰ø°ÊÅØÔºàÁî®‰∫éÁîüÊàêÁ®≥ÂÆöÁöÑÊú∫Âô®Á†ÅÔºâ
      - /etc/machine-id:/host/etc/machine-id:ro
      - /sys/class/net:/host/sys/class/net:ro
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
      redis:
        condition: service_healthy
      web:
        condition: service_started
    networks:
      - secsnow-network
    healthcheck:
      test: ["CMD", "celery", "-A", "secsnow", "inspect", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Celery BeatÔºàÂÖ±‰∫´ web ÈïúÂÉèÔºâ
  celery-beat:
    image: ${SECSNOW_IMAGE:-secsnow:secure}
    container_name: ${CONTAINER_PREFIX:-secsnow}-celery-beat
    restart: always
    env_file:                    # ‚¨Ö Êñ∞Â¢û
      - .env
    command: celery -A secsnow beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    environment:
      # Django ÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºâ
      SNOW_SECRET_KEY: ${SNOW_SECRET_KEY:-change-this-to-random-string}
      SNOW_DEBUG: ${SNOW_DEBUG:-False}
      # Êï∞ÊçÆÂ∫ìÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºâ- ÈÄöËøá PgBouncer ËøûÊé•
      SNOW_POSTGRES_HOST: pgbouncer
      SNOW_POSTGRES_PORT: 5432
      SNOW_POSTGRES_NAME: ${POSTGRES_DB:-secsnow}
      SNOW_POSTGRES_USER: ${POSTGRES_USER:-secsnow}
      SNOW_POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-secsnow123456}
      # Redis ÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºâ
      SNOW_REDIS_HOST: redis
      SNOW_REDIS_PORT: 6379
      SNOW_REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123456}
      # Êó∂Âå∫ÈÖçÁΩÆ
      TZ: Asia/Shanghai
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${WEB_LOG_DIR:-./web/log}:/opt/cloud/secsnow/log
      # ÊåÇËΩΩÂÆø‰∏ªÊú∫‰ø°ÊÅØÔºàÁî®‰∫éÁîüÊàêÁ®≥ÂÆöÁöÑÊú∫Âô®Á†ÅÔºâ
      - /etc/machine-id:/host/etc/machine-id:ro
      - /sys/class/net:/host/sys/class/net:ro
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
      redis:
        condition: service_healthy
      web:
        condition: service_started
    networks:
      - secsnow-network

  # Flower ÁõëÊéßÔºàÂèØÈÄâÊúçÂä° - ‰ΩøÁî® --profile Flower ÂêØÂä®Ôºâ
  flower:
    profiles:
      - Flower  # ÈúÄË¶Å‰ΩøÁî® --profile Flower ÂèÇÊï∞Êâç‰ºöÂêØÂä®Ê≠§ÊúçÂä°
    image: ${SECSNOW_IMAGE:-secsnow:secure}
    container_name: ${CONTAINER_PREFIX:-secsnow}-flower
    restart: always
    # Ê∑ªÂä†Âü∫Êú¨ËÆ§ËØÅ‰øùÊä§ÔºàÁî®Êà∑Âêç:ÂØÜÁ†ÅÊ†ºÂºèÔºâ
    command: >
      celery -A secsnow flower 
      --port=5555 
      --basic_auth=${FLOWER_USER:-admin}:${FLOWER_PASSWORD:-flower123456}
    environment:
      # Redis ÈÖçÁΩÆÔºà‰ΩøÁî® SNOW_ ÂâçÁºÄÔºâ
      SNOW_REDIS_HOST: redis
      SNOW_REDIS_PORT: 6379
      SNOW_REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123456}
      # Êó∂Âå∫ÈÖçÁΩÆ
      TZ: Asia/Shanghai
    # Áõ¥Êé•Êö¥Èú≤ 5555 Á´ØÂè£Âà∞‰∏ªÊú∫
    ports:
      - "${FLOWER_PORT:-5555}:5555"
    depends_on:
      - redis
      - celery-worker
    networks:
      - secsnow-network

  # Nginx ÂèçÂêë‰ª£ÁêÜ
  nginx:
    image: ${NGINX_IMAGE:-nginx:alpine}
    container_name: ${CONTAINER_PREFIX:-secsnow}-nginx
    restart: always
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ${NGINX_CONF_DIR:-./nginx/conf.d}:/etc/nginx/conf.d:ro
      - ${NGINX_SSL_DIR:-./nginx/ssl}:/etc/nginx/ssl:ro
      - ${WEB_MEDIA_DIR:-./web/media}:/usr/share/nginx/secsnow/media
      - ${WEB_STATIC_DIR:-./web/static}:/usr/share/nginx/secsnow/static
      - ${NGINX_LOG_DIR:-./web/log/nginx}:/var/log/nginx
    depends_on:
      - web
    networks:
      - secsnow-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  secsnow-network:
    name: ${NETWORK_NAME:-secsnow-network}
    driver: bridge

volumes:
  postgres-data:
  redis-data:

